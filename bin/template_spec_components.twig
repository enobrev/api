<?php
    namespace {{ spec.namespace.spec }}\_components;

    use Adbar\Dot;

    use Enobrev\API\DataMap;
    use Enobrev\API\FullSpec;
    use Enobrev\API\FullSpec\ComponentListInterface;
    use Enobrev\API\FullSpec\Component\Reference;
    use Enobrev\API\FullSpec\Component\Request;
    use Enobrev\API\FullSpec\Component\Response;
    use Enobrev\API\FullSpec\Component\Schema;
    use Enobrev\API\Param;
    use Enobrev\API\Spec;

    use {{ spec.namespace.table }};

    class {{ table.name }} implements ComponentListInterface {
{% if spec.show_post %}
        const SCHEMA_POST          = Schema::PREFIX    . '/{{ table.name }}-post';
{% endif %}
{% if spec.show_keyless_post %}
        const SCHEMA_KEYLESS_POST  = Schema::PREFIX    . '/{{ table.name }}-post-keyless';
{% endif %}
{% if spec.show_post %}
        const REQUEST_POST         = Request::PREFIX   . '/{{ table.name }}';
{% endif %}
{% if spec.show_keyless_post %}
        const REQUEST_KEYLESS_POST = Request::PREFIX   . '/{{ table.name }}-keyless';
{% endif %}
        const RESPONSE_SUCCESS     = Response::PREFIX  . '/{{ table.name }}-cms';

        /** @return ComponentListInterface[] */
        public function components(): array {
            return [
{% if spec.show_post %}
                Schema::create(self::SCHEMA_POST)->schema(Spec::tableToRequestBodyJsonSchema(new {{ table.class }}, {{ spec.non_post|raw }})),
{% endif %}
{% if spec.show_keyless_post %}
                Schema::create(self::SCHEMA_KEYLESS_POST)->schema(Spec::tableToRequestBodyJsonSchema(new {{ table.class }}, {{ spec.non_keyless_post|raw }})),
{% endif %}
{% if spec.show_post %}
                Request::create(self::REQUEST_POST)
                    ->description('`{{ table.name }}` Request')
                    ->post(Reference::create(self::SCHEMA_POST))
                    ->json(Reference::create(self::SCHEMA_POST)),

{% endif %}
{% if spec.show_keyless_post %}
                Request::create(self::REQUEST_KEYLESS_POST)
                    ->description('`{{ table.name }}` Request')
                    ->post(Reference::create(self::SCHEMA_KEYLESS_POST))
                    ->json(Reference::create(self::SCHEMA_KEYLESS_POST)),

{% endif %}
                Response::create(self::RESPONSE_SUCCESS)
                    ->description('Successful `{{ table.name }}` Response')
                    ->json(
                        Spec\JsonResponse::allOf([
                            Reference::create(FullSpec::SCHEMA_DEFAULT),
                            [
                                'counts.{{ table.name }}' => Param\_Integer::create(),
                                'sorts.{{ table.name }}'  => Param\_Array::create()->items(new Param\_String()),
                                '{{ table.name }}.{% for field in primary %}{{ '{' }}{{ field.short }}{{ '}' }}{% if not loop.last %}-{% endif %}{% endfor %}' => Spec::tableToJsonSchema(new {{ table.class }})
                            ]
                        ])
                    )
            ];
        }

        public static function add{{ table.title }}ToResponse(Dot $oResponse, {{ table.class }} $o{{ table.title }}): Dot {
{% if primary|length > 1 %}
            $oResponse->set("{{ table.name }}.{% for field in primary %}{{ '{' }}$o{{ table.title }}->{{ field.name }}->getValue(){{ '}' }}{% if not loop.last %}-{% endif %}{% endfor %}", DataMap::convertTableToResponseArray($o{{ table.title }}));
{% else %}
            $oResponse->set("{{ table.name }}.{$o{{ table.title }}->{{ primary.0.name }}->getValue()}", DataMap::convertTableToResponseArray($o{{ table.title }}));
{% endif %}
            return $oResponse;
        }

        public static function add{{ table.plural }}ToResponse(Dot $oResponse, {{ table.class_plural }} $o{{ table.plural }}): Dot {
            foreach($o{{ table.plural }} as $o{{ table.title }}) {
                $oResponse = self::add{{ table.title }}ToResponse($oResponse, $o{{ table.title }});
            }
            return $oResponse;
        }
    }