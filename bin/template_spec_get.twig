<?php
    namespace {{ spec.namespace.spec }}\{{ table.name }};

    use Adbar\Dot;
    use Psr\Http\Message\ResponseInterface;
    use Psr\Http\Message\ServerRequestInterface;
    use Psr\Http\Server\MiddlewareInterface;
    use Psr\Http\Server\RequestHandlerInterface;
    use Zend\Diactoros\Response\JsonResponse;

    use Enobrev\API\DataMap;
    use Enobrev\API\Method;
    use Enobrev\API\Middleware\FastRoute;
    use Enobrev\API\Middleware\ResponseBuilder;
    use Enobrev\API\Param;
    use Enobrev\API\Spec;
    use Enobrev\API\SpecInterface;

    use {{ spec.namespace.table }};

    class {{ spec.name }} implements SpecInterface, MiddlewareInterface {
        public function spec(): Spec {
            $oSpec = new Spec();
            $oSpec->HttpMethod        = Method\{{ spec.http_method }};
            $oSpec->Path              = '{{ spec.path_prefix}}/{{ table.name }}/{% for field in primary %}{{ '{' }}{{ field.short }}{{ '}' }}{% if not loop.last %}-{% endif %}{% endfor %}';
            $oSpec->Summary           = 'Get `{{ table.name }}`';
{% if primary|length > 1 %}
            $oSpec->Description       = 'Get `{{ table.name }}` designated by {% for field in primary%}{% if loop.first %}{% elseif loop.last %} and {% else %}, {% endif %}`{{ field.short }}`{% endfor %}';
{% else %}
            $oSpec->Description       = 'Get `{{ table.name }}` designated by comma separated list of `{{ primary.0.short }}`';
{% endif %}
            $oSpec->Scopes            = {{ spec.scopes|raw }};

{% if primary|length > 1 %}
{% for field in primary %}
            $oSpec->PathParams['{{ field.short }}'] = new Param\{{ field.param_class }}('{{ field.short }}', Param::REQUIRED);
{% endfor %}
{% else %}
            $oSpec->PathParams['{{ primary.0.short }}']  = new Param\_Array('{{ primary.0.short }}', Param::REQUIRED, ['items' => ['type' => '{{ primary.0.param_list_type }}']]);
{% endif %}

            $oSpec->ResponseSchema    = [
                'type' => 'object',
                'properties' => [
                    '{{ table.name }}' => [
                        'type' => 'object',
                        'properties' => [
                            '{% for field in primary %}{{ '{' }}{{ field.short }}{{ '}' }}{% if not loop.last %}-{% endif %}{% endfor %}' => [
                                'type' => 'object',
                                'properties' => Spec::tableToParams(new {{ table.class }})
                            ]
                        ]
                    ]
                ]
            ];

            return $oSpec;
        }

        /**
         * Middleware
         * Use the ServerRequestInterface to figure out what is needed
         * Either return a ResponseInterface (and stop processing other Middleware)
         *     or return a call to Handler::handle (and allow other Middleware to continue processing)
         * The ResponseBuilder data should match the Schema defined in spec();

         * @param ServerRequestInterface $oRequest
         * @param RequestHandlerInterface $oHandler
         * @return ResponseInterface
         */
        public function process(ServerRequestInterface $oRequest, RequestHandlerInterface $oHandler): ResponseInterface {
            $aPathParams = FastRoute::getPathParams($oRequest);
            $oBuilder    = ResponseBuilder::get($oRequest);

{% if primary|length > 1 %}
            $o{{ table.title }} = {{ table.class }}::getById({% for field in primary %}$aPathParams['{{ field.short }}']{% if not loop.last %}, {% endif %}{% endfor %});
            if ($o{{ table.title }} instanceof {{ table.class }}) {
                $oBuilder->set("{{ table.name }}.{% for field in primary %}{{ '{' }}$o{{ table.title }}->{{ field.name }}->getValue(){{ '}' }}{% if not loop.last %}-{% endif %}{% endfor %}", DataMap::convertTableToResponseArray($o{{ table.title }}));
            }
{% else %}
            $a{{ table.plural }} = {{ table.class_plural }}::getBy{{ primary.0.plural }}({% for field in primary %}$aPathParams['{{ field.short }}']{% if not loop.last %}, {% endif %}{% endfor %});
            foreach($a{{ table.plural }} as $o{{ table.title }}) {
                $oBuilder->set("{{ table.name }}.{$o{{ table.title }}->{{ primary.0.name }}->getValue()}", DataMap::convertTableToResponseArray($o{{ table.title }}));
            }
{% endif %}

            return $oHandler->handle(ResponseBuilder::update($oRequest, $oBuilder));
        }
    }